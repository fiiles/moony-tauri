name: Dependency Check

on:
  schedule:
    # Run weekly on Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-dependencies:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Install cargo-outdated
        run: cargo install cargo-outdated

      - name: Check npm dependencies
        id: npm-check
        run: |
          echo "## ðŸ“¦ NPM Dependencies" >> npm-report.md
          echo "" >> npm-report.md

          # Run npm outdated and capture output
          npm outdated --json > npm-outdated.json 2>/dev/null || true

          if [ -s npm-outdated.json ] && [ "$(cat npm-outdated.json)" != "{}" ]; then
            echo "| Package | Current | Wanted | Latest | Type |" >> npm-report.md
            echo "|---------|---------|--------|--------|------|" >> npm-report.md
            
            # Parse JSON and create markdown table
            jq -r 'to_entries[] | "| \(.key) | \(.value.current // "N/A") | \(.value.wanted // "N/A") | \(.value.latest // "N/A") | \(.value.type // "N/A") |"' npm-outdated.json >> npm-report.md
            
            echo "has_npm_updates=true" >> $GITHUB_OUTPUT
            echo "npm_count=$(jq 'length' npm-outdated.json)" >> $GITHUB_OUTPUT
          else
            echo "âœ… All npm packages are up to date!" >> npm-report.md
            echo "has_npm_updates=false" >> $GITHUB_OUTPUT
            echo "npm_count=0" >> $GITHUB_OUTPUT
          fi
          echo "" >> npm-report.md

      - name: Check Rust dependencies
        id: cargo-check
        working-directory: src-tauri
        run: |
          echo "## ðŸ¦€ Rust Dependencies" >> ../cargo-report.md
          echo "" >> ../cargo-report.md

          # Run cargo-outdated and capture output
          cargo outdated --format json > cargo-outdated.json 2>/dev/null || echo '{"dependencies":[]}' > cargo-outdated.json

          OUTDATED_COUNT=$(jq '[.dependencies[] | select(.latest != .project)] | length' cargo-outdated.json)

          if [ "$OUTDATED_COUNT" -gt 0 ]; then
            echo "| Crate | Current | Latest | Kind |" >> ../cargo-report.md
            echo "|-------|---------|--------|------|" >> ../cargo-report.md
            
            jq -r '.dependencies[] | select(.latest != .project) | "| \(.name) | \(.project) | \(.latest) | \(.kind // "normal") |"' cargo-outdated.json >> ../cargo-report.md
            
            echo "has_cargo_updates=true" >> $GITHUB_OUTPUT
            echo "cargo_count=$OUTDATED_COUNT" >> $GITHUB_OUTPUT
          else
            echo "âœ… All Rust crates are up to date!" >> ../cargo-report.md
            echo "has_cargo_updates=false" >> $GITHUB_OUTPUT
            echo "cargo_count=0" >> $GITHUB_OUTPUT
          fi
          echo "" >> ../cargo-report.md

      - name: Check GitHub Actions
        id: actions-check
        run: |
          echo "## âš¡ GitHub Actions" >> actions-report.md
          echo "" >> actions-report.md

          # Simple check for actions in workflow files
          ACTIONS_FOUND=false
          echo "| Action | Current Version |" >> actions-report.md
          echo "|--------|-----------------|" >> actions-report.md

          for file in .github/workflows/*.yml; do
            if [ -f "$file" ]; then
              grep -oE 'uses: [^@]+@[^ ]+' "$file" 2>/dev/null | sed 's/uses: //' | while read action; do
                echo "| $action | (manual check required) |" >> actions-report.md
                ACTIONS_FOUND=true
              done
            fi
          done || true

          echo "" >> actions-report.md
          echo "> ðŸ’¡ **Tip:** Visit the [GitHub Actions Marketplace](https://github.com/marketplace?type=actions) to check for updates." >> actions-report.md
          echo "" >> actions-report.md

      - name: Generate summary
        id: summary
        run: |
          # Create the full report
          DATE=$(date '+%Y-%m-%d')

          cat > report.md << 'EOF'
          # ðŸ“‹ Dependency Update Summary

          **Generated:** $(date '+%Y-%m-%d %H:%M UTC')

          This report shows outdated dependencies across all package ecosystems.

          ---

          EOF

          # Add date properly
          sed -i "s/\$(date '+%Y-%m-%d %H:%M UTC')/$DATE/" report.md

          # Add individual reports
          cat npm-report.md >> report.md
          cat cargo-report.md >> report.md
          cat actions-report.md >> report.md

          # Add footer
          cat >> report.md << 'EOF'

          ---

          ## ðŸ”„ How to Update

          ### NPM Packages
          ```bash
          npm update           # Update to wanted versions
          npm update <package> # Update specific package
          ```

          ### Rust Crates
          ```bash
          cd src-tauri
          cargo update         # Update Cargo.lock
          cargo upgrade        # Update Cargo.toml (requires cargo-edit)
          ```

          ### GitHub Actions
          Manually update version tags in `.github/workflows/*.yml` files.

          ---

          *This issue was automatically generated by the [Dependency Check workflow](.github/workflows/dependency-check.yml).*
          EOF

          # Calculate totals
          NPM_COUNT="${{ steps.npm-check.outputs.npm_count }}"
          CARGO_COUNT="${{ steps.cargo-check.outputs.cargo_count }}"
          TOTAL=$((NPM_COUNT + CARGO_COUNT))

          echo "total_updates=$TOTAL" >> $GITHUB_OUTPUT
          echo "report_body<<EOFMARKER" >> $GITHUB_OUTPUT
          cat report.md >> $GITHUB_OUTPUT
          echo "EOFMARKER" >> $GITHUB_OUTPUT

      - name: Create or update issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ“¦ Weekly Dependency Update Summary';
            const body = `${{ steps.summary.outputs.report_body }}`;
            const labels = ['dependencies', 'automated'];

            // Search for existing open issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: labels.join(','),
            });

            const existingIssue = issues.find(issue => issue.title === title);

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body,
              });
              console.log(`Updated issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const { data: newIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: labels,
              });
              console.log(`Created issue #${newIssue.number}`);
            }
